openapi: 3.0.3
info:
  title: QAWave API
  description: |
    AI-powered QA automation platform API.

    QAWave automatically generates test scenarios from OpenAPI specifications and
    business requirements, executes them against your APIs, and provides detailed
    coverage reports.

    ## Authentication

    Authentication is handled via Keycloak OAuth2/OIDC.
    - **Frontend**: Uses PKCE flow with `qawave-frontend` client
    - **Backend-to-Backend**: Uses client credentials with `qawave-backend` client

    Include the access token in the Authorization header:
    ```
    Authorization: Bearer <access_token>
    ```

    ## Rate Limiting

    API calls are rate-limited to protect system resources:
    - Standard: 100 requests/minute per user
    - AI Operations: 10 requests/minute per user

    Rate limit headers are included in responses:
    - `X-RateLimit-Limit`: Maximum requests allowed
    - `X-RateLimit-Remaining`: Requests remaining
    - `X-RateLimit-Reset`: Time until limit resets (Unix timestamp)

  version: 1.0.0
  contact:
    name: QAWave Team
    email: support@qawave.io
  license:
    name: Proprietary
    url: https://qawave.io/license

servers:
  - url: http://localhost:8080
    description: Local development
  - url: https://api.qawave-staging.local
    description: Staging environment
  - url: https://api.qawave.io
    description: Production

tags:
  - name: QA Packages
    description: |
      QA Packages are the core resource in QAWave. A package represents a single
      test generation and execution run against a target API.
  - name: Scenarios
    description: |
      Test scenarios generated by AI or created manually. Each scenario contains
      ordered test steps that are executed sequentially.
  - name: Test Runs
    description: |
      Execution records for test scenarios. Each run contains step-by-step results.
  - name: Events
    description: |
      Real-time events emitted during QA package execution. Use for progress tracking.
  - name: Health
    description: Health check endpoints
  - name: Documentation
    description: API documentation utilities

paths:
  /api/qa/packages:
    get:
      tags:
        - QA Packages
      summary: List all QA packages
      description: Retrieves a paginated list of all QA packages, optionally filtered by status.
      operationId: listPackages
      parameters:
        - name: page
          in: query
          description: Page number (0-indexed)
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: size
          in: query
          description: Number of items per page
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: status
          in: query
          description: Filter by package status
          required: false
          schema:
            $ref: '#/components/schemas/QaPackageStatus'
      responses:
        '200':
          description: Packages retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagedQaPackageResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - QA Packages
      summary: Create a new QA package
      description: |
        Creates a new QA package that will generate test scenarios from the provided
        OpenAPI specification and requirements.

        Provide either `specUrl` (URL to fetch spec from) or `specContent` (inline spec).
      operationId: createPackage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateQaPackageRequest'
            examples:
              withSpecUrl:
                summary: With spec URL
                value:
                  name: "Pet Store API Tests"
                  description: "Generated tests for Pet Store API"
                  specUrl: "https://petstore3.swagger.io/api/v3/openapi.json"
                  baseUrl: "https://petstore3.swagger.io/api/v3"
                  requirements: "Test all CRUD operations for pets"
              withSpecContent:
                summary: With inline spec
                value:
                  name: "Custom API Tests"
                  baseUrl: "https://api.example.com"
                  specContent: "openapi: 3.0.0\ninfo:\n  title: Example\n  version: 1.0.0"
      responses:
        '201':
          description: Package created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QaPackageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/qa/packages/{id}:
    get:
      tags:
        - QA Packages
      summary: Get a QA package by ID
      description: Retrieves detailed information about a specific QA package.
      operationId: getPackage
      parameters:
        - $ref: '#/components/parameters/PackageId'
      responses:
        '200':
          description: Package found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QaPackageResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      tags:
        - QA Packages
      summary: Update a QA package
      description: Updates an existing QA package. Only provided fields will be updated.
      operationId: updatePackage
      parameters:
        - $ref: '#/components/parameters/PackageId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateQaPackageRequest'
      responses:
        '200':
          description: Package updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QaPackageResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      tags:
        - QA Packages
      summary: Delete a QA package
      description: Deletes a QA package and all associated scenarios and runs.
      operationId: deletePackage
      parameters:
        - $ref: '#/components/parameters/PackageId'
      responses:
        '204':
          description: Package deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/qa/packages/{id}/status:
    patch:
      tags:
        - QA Packages
      summary: Update package status
      description: |
        Updates the status of a QA package. Valid transitions depend on current status:
        - DRAFT → RUNNING
        - RUNNING → COMPLETED, FAILED
        - COMPLETED → ARCHIVED
        - FAILED → RUNNING (retry)
      operationId: updateStatus
      parameters:
        - $ref: '#/components/parameters/PackageId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  $ref: '#/components/schemas/QaPackageStatus'
      responses:
        '200':
          description: Status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QaPackageResponse'
        '400':
          description: Invalid status transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/qa/packages/count:
    get:
      tags:
        - QA Packages
      summary: Get package count
      description: Returns the total number of packages, optionally filtered by status.
      operationId: getPackageCount
      parameters:
        - name: status
          in: query
          description: Filter by status
          required: false
          schema:
            $ref: '#/components/schemas/QaPackageStatus'
      responses:
        '200':
          description: Count returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                    format: int64
                    example: 42

  /api/health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the service.
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: UP
                  service:
                    type: string
                    example: qawave

  /api/docs/info:
    get:
      tags:
        - Documentation
      summary: Get API documentation info
      description: Returns information about where to access API documentation.
      operationId: getDocInfo
      responses:
        '200':
          description: Documentation info returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  swaggerUi:
                    type: string
                    example: /swagger-ui.html
                  apiDocs:
                    type: string
                    example: /api-docs
                  apiDocsYaml:
                    type: string
                    example: /api-docs.yaml
                  version:
                    type: string
                    example: 1.0.0

components:
  schemas:
    CreateQaPackageRequest:
      type: object
      required:
        - name
        - baseUrl
      properties:
        name:
          type: string
          description: Human-readable name for the package
          minLength: 1
          maxLength: 255
          example: "Pet Store API Tests"
        description:
          type: string
          description: Optional description
          maxLength: 1000
          example: "Comprehensive tests for Pet Store REST API"
        specUrl:
          type: string
          format: uri
          description: URL to fetch OpenAPI specification from
          example: "https://petstore3.swagger.io/api/v3/openapi.json"
        specContent:
          type: string
          description: Inline OpenAPI specification (YAML or JSON)
        baseUrl:
          type: string
          format: uri
          description: Base URL of the API to test
          example: "https://petstore3.swagger.io/api/v3"
        requirements:
          type: string
          description: Business requirements to guide test generation
          example: "Test all CRUD operations, validate error handling"
        config:
          $ref: '#/components/schemas/QaPackageConfigRequest'

    UpdateQaPackageRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 255
        description:
          type: string
          maxLength: 1000
        specUrl:
          type: string
          format: uri
        specContent:
          type: string
        baseUrl:
          type: string
          format: uri
        requirements:
          type: string
        config:
          $ref: '#/components/schemas/QaPackageConfigRequest'

    QaPackageConfigRequest:
      type: object
      description: Configuration options for test generation and execution
      properties:
        maxScenarios:
          type: integer
          description: Maximum number of scenarios to generate
          default: 10
          minimum: 1
          maximum: 100
        maxStepsPerScenario:
          type: integer
          description: Maximum steps per scenario
          default: 10
          minimum: 1
          maximum: 50
        timeoutMs:
          type: integer
          format: int64
          description: Overall timeout in milliseconds
          default: 300000
          minimum: 1000
          maximum: 3600000
        parallelExecution:
          type: boolean
          description: Execute scenarios in parallel
          default: true
        stopOnFirstFailure:
          type: boolean
          description: Stop execution on first failure
          default: false
        includeSecurityTests:
          type: boolean
          description: Include security-focused test scenarios
          default: false
        aiProvider:
          type: string
          description: AI provider to use
          default: openai
          enum:
            - openai
            - venice
            - anthropic
        aiModel:
          type: string
          description: Specific AI model to use
          default: gpt-4o-mini

    QaPackageResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique package identifier
        name:
          type: string
        description:
          type: string
          nullable: true
        specUrl:
          type: string
          nullable: true
        specHash:
          type: string
          nullable: true
          description: SHA-256 hash of the OpenAPI spec
        baseUrl:
          type: string
        requirements:
          type: string
          nullable: true
        status:
          $ref: '#/components/schemas/QaPackageStatus'
        config:
          $ref: '#/components/schemas/QaPackageConfigResponse'
        coverage:
          $ref: '#/components/schemas/CoverageReportResponse'
        qaSummary:
          $ref: '#/components/schemas/QaSummaryResponse'
        scenarioCount:
          type: integer
          description: Number of generated scenarios
        triggeredBy:
          type: string
          description: User or system that triggered the package
        startedAt:
          type: string
          format: date-time
          nullable: true
        completedAt:
          type: string
          format: date-time
          nullable: true
        durationMs:
          type: integer
          format: int64
          nullable: true
          description: Total execution duration in milliseconds
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    QaPackageConfigResponse:
      type: object
      properties:
        maxScenarios:
          type: integer
        maxStepsPerScenario:
          type: integer
        timeoutMs:
          type: integer
          format: int64
        parallelExecution:
          type: boolean
        stopOnFirstFailure:
          type: boolean
        includeSecurityTests:
          type: boolean
        aiProvider:
          type: string
        aiModel:
          type: string

    CoverageReportResponse:
      type: object
      nullable: true
      properties:
        totalOperations:
          type: integer
          description: Total operations in the OpenAPI spec
        coveredOperations:
          type: integer
          description: Operations covered by at least one test
        coveragePercentage:
          type: number
          format: double
          description: Coverage as a percentage (0-100)
        uncoveredOperations:
          type: integer
          description: Operations without test coverage
        generatedAt:
          type: string
          format: date-time

    QaSummaryResponse:
      type: object
      nullable: true
      properties:
        overallVerdict:
          type: string
          enum:
            - PASSED
            - FAILED
            - PARTIAL
            - ERROR
        summary:
          type: string
          description: AI-generated summary of test results
        passedScenarios:
          type: integer
        failedScenarios:
          type: integer
        erroredScenarios:
          type: integer
        qualityScore:
          type: integer
          nullable: true
          minimum: 0
          maximum: 100
          description: Overall quality score
        stabilityScore:
          type: integer
          nullable: true
          minimum: 0
          maximum: 100
          description: API stability score
        generatedAt:
          type: string
          format: date-time

    QaPackageStatus:
      type: string
      enum:
        - DRAFT
        - RUNNING
        - COMPLETED
        - FAILED
        - ARCHIVED
      description: |
        - DRAFT: Package created, not yet executed
        - RUNNING: Test generation/execution in progress
        - COMPLETED: All tests executed successfully
        - FAILED: Execution failed or tests failed
        - ARCHIVED: Package archived for historical reference

    PagedQaPackageResponse:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/QaPackageResponse'
        page:
          type: integer
          description: Current page number (0-indexed)
        size:
          type: integer
          description: Number of items per page
        totalElements:
          type: integer
          format: int64
          description: Total number of items
        totalPages:
          type: integer
          description: Total number of pages
        hasNext:
          type: boolean
        hasPrevious:
          type: boolean

    ErrorResponse:
      type: object
      description: Standard error response following RFC 7807
      required:
        - message
      properties:
        message:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Machine-readable error code
          example: VALIDATION_ERROR
        details:
          type: object
          additionalProperties: true
          description: Additional error details
        timestamp:
          type: string
          format: date-time
      example:
        message: "Validation failed"
        code: "VALIDATION_ERROR"
        details:
          field: "name"
          reason: "must not be blank"
        timestamp: "2026-01-30T12:00:00Z"

  parameters:
    PackageId:
      name: id
      in: path
      description: QA Package UUID
      required: true
      schema:
        type: string
        format: uuid

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            message: "Validation failed: name is required"
            code: "VALIDATION_ERROR"
            timestamp: "2026-01-30T12:00:00Z"

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            message: "Authentication required"
            code: "UNAUTHORIZED"
            timestamp: "2026-01-30T12:00:00Z"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            message: "QA Package not found"
            code: "NOT_FOUND"
            timestamp: "2026-01-30T12:00:00Z"

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token obtained from Keycloak.

        For frontend apps, use the PKCE flow with the `qawave-frontend` client.
        For service-to-service calls, use client credentials with `qawave-backend`.

security:
  - bearerAuth: []
