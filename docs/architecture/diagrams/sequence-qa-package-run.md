# Sequence Diagram: QA Package Run

## Overview

This document shows the sequence of operations when a QA package run is triggered.

## Full QA Package Run Sequence

```
┌──────┐    ┌──────────┐    ┌───────────────┐    ┌─────────────┐    ┌───────────────┐    ┌──────────┐
│Client│    │Controller│    │QaPackageRunSvc│    │ScenarioGen  │    │TestExecutor   │    │EventPub  │
└──┬───┘    └────┬─────┘    └──────┬────────┘    └──────┬──────┘    └──────┬────────┘    └────┬─────┘
   │             │                 │                    │                  │                  │
   │ POST /run   │                 │                    │                  │                  │
   │────────────►│                 │                    │                  │                  │
   │             │                 │                    │                  │                  │
   │             │ runPackage()    │                    │                  │                  │
   │             │────────────────►│                    │                  │                  │
   │             │                 │                    │                  │                  │
   │             │                 │ publish(REQUESTED) │                  │                  │
   │             │                 │────────────────────────────────────────────────────────►│
   │             │                 │                    │                  │                  │
   │             │                 │ fetchSpec()        │                  │                  │
   │             │                 │─────────┐          │                  │                  │
   │             │                 │         │          │                  │                  │
   │             │                 │◄────────┘          │                  │                  │
   │             │                 │                    │                  │                  │
   │             │                 │ publish(SPEC_FETCHED)                 │                  │
   │             │                 │────────────────────────────────────────────────────────►│
   │             │                 │                    │                  │                  │
   │             │                 │ parseOperations()  │                  │                  │
   │             │                 │─────────┐          │                  │                  │
   │             │                 │         │          │                  │                  │
   │             │                 │◄────────┘          │                  │                  │
   │             │                 │                    │                  │                  │
   │             │                 │                    │                  │                  │
   │             │                 │=================== STREAMING PIPELINE ==================│
   │             │                 │                    │                  │                  │
   │             │                 │ FOR EACH OPERATION (parallel)         │                  │
   │             │                 │ ┌──────────────────┼──────────────────┼──────────────────┤
   │             │                 │ │                  │                  │                  │
   │             │                 │ │ generate()       │                  │                  │
   │             │                 │ │─────────────────►│                  │                  │
   │             │                 │ │                  │                  │                  │
   │             │                 │ │                  │ AI API call      │                  │
   │             │                 │ │                  │─────────┐        │                  │
   │             │                 │ │                  │         │        │                  │
   │             │                 │ │                  │◄────────┘        │                  │
   │             │                 │ │                  │                  │                  │
   │             │                 │ │     scenario     │                  │                  │
   │             │                 │ │◄─────────────────│                  │                  │
   │             │                 │ │                  │                  │                  │
   │             │                 │ │ publish(SCENARIO_CREATED)           │                  │
   │             │                 │ │────────────────────────────────────────────────────►│
   │             │                 │ │                  │                  │                  │
   │             │                 │ │ execute(scenario, baseUrl)          │                  │
   │             │                 │ │─────────────────────────────────────►│                 │
   │             │                 │ │                  │                  │                  │
   │             │                 │ │                  │    HTTP call     │                  │
   │             │                 │ │                  │   to target API  │                  │
   │             │                 │ │                  │──────────────────┤                  │
   │             │                 │ │                  │                  │                  │
   │             │                 │ │                  │     response     │                  │
   │             │                 │ │                  │◄─────────────────┤                  │
   │             │                 │ │                  │                  │                  │
   │             │                 │ │      result      │                  │                  │
   │             │                 │ │◄─────────────────────────────────────│                 │
   │             │                 │ │                  │                  │                  │
   │             │                 │ │ publish(EXECUTION_SUCCESS/FAILED)   │                  │
   │             │                 │ │────────────────────────────────────────────────────►│
   │             │                 │ │                  │                  │                  │
   │             │                 │ └──────────────────┼──────────────────┼──────────────────┤
   │             │                 │                    │                  │                  │
   │             │                 │================= END STREAMING ======================│
   │             │                 │                    │                  │                  │
   │             │                 │ collectResults()   │                  │                  │
   │             │                 │─────────┐          │                  │                  │
   │             │                 │         │          │                  │                  │
   │             │                 │◄────────┘          │                  │                  │
   │             │                 │                    │                  │                  │
   │             │                 │ publish(AI_SUCCESS)│                  │                  │
   │             │                 │────────────────────────────────────────────────────────►│
   │             │                 │                    │                  │                  │
   │             │                 │ evaluateQa()       │                  │                  │
   │             │                 │─────────┐          │                  │                  │
   │             │                 │         │          │                  │                  │
   │             │                 │◄────────┘          │                  │                  │
   │             │                 │                    │                  │                  │
   │             │                 │ publish(QA_EVAL_DONE)                 │                  │
   │             │                 │────────────────────────────────────────────────────────►│
   │             │                 │                    │                  │                  │
   │             │                 │ saveResults()      │                  │                  │
   │             │                 │─────────┐          │                  │                  │
   │             │                 │         │          │                  │                  │
   │             │                 │◄────────┘          │                  │                  │
   │             │                 │                    │                  │                  │
   │             │                 │ publish(COMPLETE)  │                  │                  │
   │             │                 │────────────────────────────────────────────────────────►│
   │             │                 │                    │                  │                  │
   │             │  QaPackageRun   │                    │                  │                  │
   │             │◄────────────────│                    │                  │                  │
   │             │                 │                    │                  │                  │
   │  202 + URL  │                 │                    │                  │                  │
   │◄────────────│                 │                    │                  │                  │
   │             │                 │                    │                  │                  │
```

## Async Flow (Recommended for Production)

For long-running packages, use async execution:

```
┌──────┐    ┌──────────┐    ┌───────────────┐    ┌───────────────┐
│Client│    │Controller│    │QaPackageRunSvc│    │CoroutineScope │
└──┬───┘    └────┬─────┘    └──────┬────────┘    └──────┬────────┘
   │             │                 │                    │
   │ POST /run   │                 │                    │
   │────────────►│                 │                    │
   │             │                 │                    │
   │             │ runAsync()      │                    │
   │             │────────────────►│                    │
   │             │                 │                    │
   │             │                 │ launch { run() }   │
   │             │                 │───────────────────►│
   │             │                 │                    │
   │             │                 │  jobId             │
   │             │   planId        │◄───────────────────│
   │             │◄────────────────│                    │
   │             │                 │                    │
   │ 202 Accepted│                 │                    │
   │ + planId    │                 │                    │
   │◄────────────│                 │                    │
   │             │                 │                    │
   │             │                 │    (continues      │
   │             │                 │     in background) │
   │             │                 │                    │
   │ GET /status/{planId}          │                    │
   │────────────►│                 │                    │
   │             │                 │                    │
   │ { status,   │                 │                    │
   │   events }  │                 │                    │
   │◄────────────│                 │                    │
```

## Error Handling Sequence

```
┌──────┐    ┌───────────────┐    ┌─────────────┐    ┌──────────┐
│Client│    │QaPackageRunSvc│    │ScenarioGen  │    │EventPub  │
└──┬───┘    └──────┬────────┘    └──────┬──────┘    └────┬─────┘
   │               │                    │                │
   │               │ generate()         │                │
   │               │───────────────────►│                │
   │               │                    │                │
   │               │                    │ AI timeout/error
   │               │                    │─────────┐      │
   │               │                    │         │      │
   │               │                    │◄────────┘      │
   │               │                    │                │
   │               │   AiException      │                │
   │               │◄───────────────────│                │
   │               │                    │                │
   │               │ publish(AI_FAILED) │                │
   │               │────────────────────────────────────►│
   │               │                    │                │
   │               │ retry(1/3)         │                │
   │               │───────────────────►│                │
   │               │                    │                │
   │               │                    │ success!       │
   │               │   scenario         │                │
   │               │◄───────────────────│                │
   │               │                    │                │
   │               │ (continue flow)    │                │
   │               │                    │                │
```

## Frontend Polling Sequence

```
┌────────┐    ┌──────────┐    ┌───────────┐
│Frontend│    │ Backend  │    │ Database  │
└───┬────┘    └────┬─────┘    └─────┬─────┘
    │              │                │
    │ GET /events/{planId}          │
    │─────────────►│                │
    │              │                │
    │              │ findByPlanId() │
    │              │───────────────►│
    │              │                │
    │              │    events[]    │
    │              │◄───────────────│
    │              │                │
    │   events[]   │                │
    │◄─────────────│                │
    │              │                │
    │ (if not COMPLETE, wait 2s)    │
    │              │                │
    │ GET /events/{planId}          │
    │─────────────►│                │
    │              │                │
    │   more events[]               │
    │◄─────────────│                │
    │              │                │
    │ (COMPLETE found, stop polling)│
    │              │                │
```

## References

- [ADR-004: Streaming Pipeline](../decisions/ADR-004-streaming-pipeline.md)
- [ADR-005: Event-Driven Architecture with Kafka](../decisions/ADR-005-event-driven-kafka.md)
