# Component Diagram

## Overview

This document details the internal components of the QAWave backend service.

## Backend Component Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    BACKEND SERVICE                                               │
│                               Spring WebFlux + Kotlin Coroutines                                │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                  │
│  ┌───────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              PRESENTATION LAYER                                            │  │
│  │                                                                                            │  │
│  │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │  │
│  │   │  QaPackage      │  │   Scenario      │  │   TestRun       │  │    Health       │     │  │
│  │   │  Controller     │  │   Controller    │  │   Controller    │  │    Controller   │     │  │
│  │   │  (suspend)      │  │   (suspend)     │  │   (suspend)     │  │                 │     │  │
│  │   └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  └─────────────────┘     │  │
│  │            │                    │                    │                                    │  │
│  │   ┌────────┴────────────────────┴────────────────────┴────────┐                          │  │
│  │   │                      DTO Layer                             │                          │  │
│  │   │  Request/Response DTOs, Validation, Mapping               │                          │  │
│  │   └───────────────────────────────────────────────────────────┘                          │  │
│  │                                                                                            │  │
│  │   Filters: CORS | Rate Limiting | Request Logging                                         │  │
│  └───────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                              │                                                   │
│                                              ▼                                                   │
│  ┌───────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              APPLICATION LAYER                                             │  │
│  │                                                                                            │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │   │                            USE CASES                                                 │ │  │
│  │   │                                                                                      │ │  │
│  │   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐        │ │  │
│  │   │  │ RunQaPackage  │  │ CreateScenario│  │ ExecuteTest   │  │ EvaluateResult│        │ │  │
│  │   │  │ UseCase       │  │ UseCase       │  │ UseCase       │  │ UseCase       │        │ │  │
│  │   │  └───────────────┘  └───────────────┘  └───────────────┘  └───────────────┘        │ │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  │                                              │                                            │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │   │                            SERVICES                                                  │ │  │
│  │   │                                                                                      │ │  │
│  │   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐        │ │  │
│  │   │  │ QaPackage     │  │  Scenario     │  │ TestExecution │  │ QaEvaluation  │        │ │  │
│  │   │  │ RunService    │  │  Service      │  │ Service       │  │ Service       │        │ │  │
│  │   │  │ (suspend)     │  │  (suspend)    │  │ (suspend)     │  │ (suspend)     │        │ │  │
│  │   │  └───────────────┘  └───────────────┘  └───────────────┘  └───────────────┘        │ │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  │                                              │                                            │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │   │                            PORTS (Interfaces)                                        │ │  │
│  │   │                                                                                      │ │  │
│  │   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐        │ │  │
│  │   │  │   AiClient    │  │ TestExecutor  │  │ EventPublisher│  │  Repositories │        │ │  │
│  │   │  │  (interface)  │  │  (interface)  │  │  (interface)  │  │  (interfaces) │        │ │  │
│  │   │  └───────────────┘  └───────────────┘  └───────────────┘  └───────────────┘        │ │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                              │                                                   │
│                                              ▼                                                   │
│  ┌───────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              DOMAIN LAYER                                                  │  │
│  │                                                                                            │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │   │                            ENTITIES                                                  │ │  │
│  │   │                                                                                      │ │  │
│  │   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐        │ │  │
│  │   │  │  QaPackage    │  │ TestScenario  │  │   TestStep    │  │   TestRun     │        │ │  │
│  │   │  │  (data class) │  │ (data class)  │  │ (data class)  │  │ (data class)  │        │ │  │
│  │   │  └───────────────┘  └───────────────┘  └───────────────┘  └───────────────┘        │ │  │
│  │   │                                                                                      │ │  │
│  │   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                            │ │  │
│  │   │  │ TestStepResult│  │   Expected    │  │ExecutionContext                           │ │  │
│  │   │  │ (data class)  │  │ (data class)  │  │ (data class)  │                            │ │  │
│  │   │  └───────────────┘  └───────────────┘  └───────────────┘                            │ │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                                            │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │   │                         VALUE OBJECTS                                                │ │  │
│  │   │                                                                                      │ │  │
│  │   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                            │ │  │
│  │   │  │   ScenarioId  │  │    PlanId     │  │    RunId      │                            │ │  │
│  │   │  │ (value class) │  │ (value class) │  │ (value class) │                            │ │  │
│  │   │  └───────────────┘  └───────────────┘  └───────────────┘                            │ │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                              ▲                                                   │
│                                              │ implements                                        │
│  ┌───────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              INFRASTRUCTURE LAYER                                          │  │
│  │                                                                                            │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │   │                            AI INTEGRATION                                            │ │  │
│  │   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                            │ │  │
│  │   │  │ OpenAiClient  │  │ VeniceClient  │  │  StubClient   │                            │ │  │
│  │   │  │ (implements   │  │ (implements   │  │ (implements   │                            │ │  │
│  │   │  │  AiClient)    │  │  AiClient)    │  │  AiClient)    │                            │ │  │
│  │   │  └───────────────┘  └───────────────┘  └───────────────┘                            │ │  │
│  │   │                                                                                      │ │  │
│  │   │  ┌───────────────────────────────────────────────────────────────────────┐          │ │  │
│  │   │  │  AiScenarioGeneratorAgent | ResultReviewerAgent | ResilientAiClient   │          │ │  │
│  │   │  └───────────────────────────────────────────────────────────────────────┘          │ │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                                            │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │   │                            PERSISTENCE                                               │ │  │
│  │   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                            │ │  │
│  │   │  │ R2dbc         │  │ R2dbc         │  │ R2dbc         │                            │ │  │
│  │   │  │ QaPackage     │  │ Scenario      │  │ TestRun       │                            │ │  │
│  │   │  │ Repository    │  │ Repository    │  │ Repository    │                            │ │  │
│  │   │  └───────────────┘  └───────────────┘  └───────────────┘                            │ │  │
│  │   │                                                                                      │ │  │
│  │   │  Entity Mapping | Flyway Migrations | Connection Pooling                            │ │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                                            │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │   │                            MESSAGING                                                 │ │  │
│  │   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                            │ │  │
│  │   │  │ Kafka         │  │ InMemory      │  │ Event         │                            │ │  │
│  │   │  │ EventPublisher│  │ EventPublisher│  │ Consumer      │                            │ │  │
│  │   │  └───────────────┘  └───────────────┘  └───────────────┘                            │ │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                                            │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │   │                            HTTP CLIENTS                                              │ │  │
│  │   │  ┌───────────────────────────────────────────────────────────────────────┐          │ │  │
│  │   │  │  WebClientTestExecutor | OpenApiParser | ResilientHttpClient          │          │ │  │
│  │   │  └───────────────────────────────────────────────────────────────────────┘          │ │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                                            │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │   │                            CACHING                                                   │ │  │
│  │   │  ┌───────────────────────────────────────────────────────────────────────┐          │ │  │
│  │   │  │  RedisCacheService | LocalCacheFallback                               │          │ │  │
│  │   │  └───────────────────────────────────────────────────────────────────────┘          │ │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                                            │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │   │                            RESILIENCE                                                │ │  │
│  │   │  ┌───────────────────────────────────────────────────────────────────────┐          │ │  │
│  │   │  │  CircuitBreaker | RateLimiter | Retry (Resilience4j)                  │          │ │  │
│  │   │  └───────────────────────────────────────────────────────────────────────┘          │ │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

## Component Interactions

### QA Package Run Flow

```
Controller ──► RunQaPackageUseCase ──► QaPackageRunService ──┬──► ScenarioGeneratorAgent ──► AiClient
                                                             │
                                                             ├──► TestExecutionService ──► TestExecutor
                                                             │
                                                             ├──► ResultEvaluator
                                                             │
                                                             └──► EventPublisher ──► Kafka
```

### Key Dependencies

| Component | Depends On | Purpose |
|-----------|------------|---------|
| QaPackageController | QaPackageRunService | HTTP endpoint handling |
| QaPackageRunService | ScenarioGeneratorAgent, TestExecutor | Orchestration |
| ScenarioGeneratorAgent | AiClient | AI scenario generation |
| TestExecutor | WebClient | HTTP execution |
| All Services | Repositories | Data persistence |
| All Services | EventPublisher | Event broadcasting |

## References

- [ADR-002: Clean Architecture with Domain-Centric Layers](../decisions/ADR-002-clean-architecture-layers.md)
- [ADR-003: AI Agent Pipeline Architecture](../decisions/ADR-003-ai-agent-pipeline.md)
