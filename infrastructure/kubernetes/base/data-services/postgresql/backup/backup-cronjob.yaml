# PostgreSQL Backup CronJob
# Performs daily pg_dump backups to S3-compatible storage
#
# Schedule: Daily at 2:00 AM UTC
# Retention: Managed by S3 lifecycle policy (30 days recommended)
# Format: Custom compressed format (-Fc) for efficient restore
#
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgresql-backup
  namespace: qawave
  labels:
    app.kubernetes.io/name: postgresql-backup
    app.kubernetes.io/component: backup
spec:
  # Run daily at 2:00 AM UTC
  schedule: "0 2 * * *"

  # Timezone (requires Kubernetes 1.27+)
  # timeZone: "UTC"

  # Concurrency policy - don't run if previous job still running
  concurrencyPolicy: Forbid

  # Keep last 3 successful jobs and 1 failed job for debugging
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1

  # Deadline for starting the job (5 hours after scheduled time)
  startingDeadlineSeconds: 18000

  jobTemplate:
    spec:
      # Retry up to 2 times on failure
      backoffLimit: 2

      # TTL for completed jobs (1 day)
      ttlSecondsAfterFinished: 86400

      template:
        metadata:
          labels:
            app.kubernetes.io/name: postgresql-backup
            app.kubernetes.io/component: backup-job
        spec:
          restartPolicy: OnFailure

          # Security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000

          containers:
            - name: backup
              image: postgres:16-alpine

              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: false
                capabilities:
                  drop:
                    - ALL

              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi

              envFrom:
                - configMapRef:
                    name: postgresql-backup-config
                - secretRef:
                    name: postgresql-backup-secrets

              env:
                # PostgreSQL connection from existing secrets
                - name: PGHOST
                  value: postgresql.qawave.svc.cluster.local
                - name: PGPORT
                  value: "5432"
                - name: PGDATABASE
                  value: qawave
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: postgresql-secrets
                      key: username
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgresql-secrets
                      key: password

              command:
                - /bin/sh
                - -c
                - |
                  set -e

                  # Install AWS CLI for S3 upload
                  apk add --no-cache aws-cli

                  # Generate backup filename with timestamp
                  TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                  BACKUP_FILE="qawave_${TIMESTAMP}.dump"

                  echo "Starting backup: ${BACKUP_FILE}"
                  echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

                  # Perform pg_dump with custom format (compressed, parallel restore)
                  pg_dump \
                    --format=custom \
                    --compress=9 \
                    --verbose \
                    --file="/tmp/${BACKUP_FILE}" \
                    --dbname="${PGDATABASE}"

                  # Get backup size
                  BACKUP_SIZE=$(stat -c%s "/tmp/${BACKUP_FILE}" 2>/dev/null || stat -f%z "/tmp/${BACKUP_FILE}")
                  echo "Backup size: ${BACKUP_SIZE} bytes"

                  # Upload to S3
                  echo "Uploading to S3: s3://${S3_BUCKET}/${S3_PREFIX}${BACKUP_FILE}"
                  aws s3 cp "/tmp/${BACKUP_FILE}" "s3://${S3_BUCKET}/${S3_PREFIX}${BACKUP_FILE}" \
                    --endpoint-url "${S3_ENDPOINT}" \
                    --sse AES256

                  # Verify upload
                  aws s3 ls "s3://${S3_BUCKET}/${S3_PREFIX}${BACKUP_FILE}" \
                    --endpoint-url "${S3_ENDPOINT}"

                  # Cleanup local file
                  rm -f "/tmp/${BACKUP_FILE}"

                  echo "Backup completed successfully"
                  echo "File: s3://${S3_BUCKET}/${S3_PREFIX}${BACKUP_FILE}"
                  echo "Size: ${BACKUP_SIZE} bytes"

              volumeMounts:
                - name: tmp-volume
                  mountPath: /tmp

          volumes:
            - name: tmp-volume
              emptyDir:
                sizeLimit: 10Gi

---
# Incremental backup CronJob (WAL archiving)
# Runs every 6 hours to archive WAL segments
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgresql-wal-archive
  namespace: qawave
  labels:
    app.kubernetes.io/name: postgresql-backup
    app.kubernetes.io/component: wal-archive
spec:
  # Run every 6 hours
  schedule: "0 */6 * * *"

  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 1

  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 43200  # 12 hours

      template:
        metadata:
          labels:
            app.kubernetes.io/name: postgresql-backup
            app.kubernetes.io/component: wal-archive-job
        spec:
          restartPolicy: OnFailure

          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000

          containers:
            - name: wal-archive
              image: postgres:16-alpine

              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: false
                capabilities:
                  drop:
                    - ALL

              resources:
                requests:
                  cpu: 50m
                  memory: 128Mi
                limits:
                  cpu: 200m
                  memory: 256Mi

              envFrom:
                - configMapRef:
                    name: postgresql-backup-config
                - secretRef:
                    name: postgresql-backup-secrets

              env:
                - name: PGHOST
                  value: postgresql.qawave.svc.cluster.local
                - name: PGPORT
                  value: "5432"
                - name: PGDATABASE
                  value: qawave
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: postgresql-secrets
                      key: username
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgresql-secrets
                      key: password

              command:
                - /bin/sh
                - -c
                - |
                  set -e

                  echo "Creating WAL checkpoint..."
                  echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

                  # Force a checkpoint to ensure WAL is flushed
                  psql -c "CHECKPOINT;"

                  # Get current WAL position for monitoring
                  psql -c "SELECT pg_current_wal_lsn();"

                  echo "WAL checkpoint completed"
