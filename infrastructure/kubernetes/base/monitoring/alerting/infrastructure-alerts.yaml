# PrometheusRule for Infrastructure Alerts
# Monitors PostgreSQL, Redis, Kafka, and Kubernetes resources

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: qawave-infrastructure-alerts
  namespace: monitoring
  labels:
    app: kube-prometheus-stack
    release: kube-prometheus-stack
    app.kubernetes.io/part-of: qawave
spec:
  groups:
    # PostgreSQL Alerts
    - name: qawave.postgresql
      interval: 30s
      rules:
        - alert: PostgreSQLDown
          expr: pg_up{job="postgresql"} == 0
          for: 1m
          labels:
            severity: critical
            service: postgresql
          annotations:
            summary: "PostgreSQL is down"
            description: "PostgreSQL database has been down for more than 1 minute."

        - alert: PostgreSQLHighConnections
          expr: |
            pg_stat_activity_count{job="postgresql"}
            /
            pg_settings_max_connections{job="postgresql"} > 0.8
          for: 5m
          labels:
            severity: warning
            service: postgresql
          annotations:
            summary: "PostgreSQL high connection usage"
            description: "Connection usage is {{ $value | humanizePercentage }}"

        - alert: PostgreSQLSlowQueries
          expr: |
            rate(pg_stat_activity_max_tx_duration{job="postgresql"}[5m]) > 60
          for: 5m
          labels:
            severity: warning
            service: postgresql
          annotations:
            summary: "PostgreSQL slow queries detected"
            description: "Long-running transactions detected"

        - alert: PostgreSQLReplicationLag
          expr: pg_replication_lag{job="postgresql"} > 30
          for: 5m
          labels:
            severity: warning
            service: postgresql
          annotations:
            summary: "PostgreSQL replication lag"
            description: "Replication lag is {{ $value }}s"

        - alert: PostgreSQLDiskSpaceLow
          expr: |
            (
              pg_database_size_bytes{job="postgresql"}
              /
              (1024 * 1024 * 1024 * 50)  # 50GB assumed
            ) > 0.8
          for: 10m
          labels:
            severity: warning
            service: postgresql
          annotations:
            summary: "PostgreSQL disk space running low"
            description: "Database size is approaching limit"

    # Redis Alerts
    - name: qawave.redis
      interval: 30s
      rules:
        - alert: RedisDown
          expr: redis_up{job="redis"} == 0
          for: 1m
          labels:
            severity: critical
            service: redis
          annotations:
            summary: "Redis is down"
            description: "Redis cache has been down for more than 1 minute."

        - alert: RedisHighMemory
          expr: |
            redis_memory_used_bytes{job="redis"}
            /
            redis_memory_max_bytes{job="redis"} > 0.85
          for: 5m
          labels:
            severity: warning
            service: redis
          annotations:
            summary: "Redis high memory usage"
            description: "Memory usage is {{ $value | humanizePercentage }}"

        - alert: RedisHighKeyEviction
          expr: rate(redis_evicted_keys_total{job="redis"}[5m]) > 100
          for: 5m
          labels:
            severity: warning
            service: redis
          annotations:
            summary: "Redis high key eviction rate"
            description: "Evicting {{ $value }} keys/second"

        - alert: RedisSlowlog
          expr: increase(redis_slowlog_length{job="redis"}[5m]) > 10
          for: 5m
          labels:
            severity: warning
            service: redis
          annotations:
            summary: "Redis slow commands detected"
            description: "{{ $value }} slow commands in the last 5 minutes"

    # Kafka Alerts
    - name: qawave.kafka
      interval: 30s
      rules:
        - alert: KafkaBrokerDown
          expr: kafka_server_replicamanager_leadercount == 0
          for: 1m
          labels:
            severity: critical
            service: kafka
          annotations:
            summary: "Kafka broker is down"
            description: "Kafka broker has no leader partitions"

        - alert: KafkaUnderReplicatedPartitions
          expr: kafka_server_replicamanager_underreplicatedpartitions > 0
          for: 5m
          labels:
            severity: warning
            service: kafka
          annotations:
            summary: "Kafka under-replicated partitions"
            description: "{{ $value }} partitions are under-replicated"

        - alert: KafkaConsumerLag
          expr: |
            kafka_consumergroup_lag_sum{group=~"qawave.*"} > 10000
          for: 10m
          labels:
            severity: warning
            service: kafka
          annotations:
            summary: "Kafka consumer lag is high"
            description: "Consumer group {{ $labels.group }} has lag of {{ $value }}"

        - alert: KafkaProducerErrors
          expr: rate(kafka_producer_record_error_total[5m]) > 0
          for: 5m
          labels:
            severity: warning
            service: kafka
          annotations:
            summary: "Kafka producer errors"
            description: "Producer is experiencing errors"

    # Kubernetes Resource Alerts
    - name: qawave.kubernetes
      interval: 30s
      rules:
        - alert: PodCrashLooping
          expr: |
            rate(kube_pod_container_status_restarts_total{namespace="qawave"}[15m]) > 0.1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod is crash looping"
            description: "Pod {{ $labels.pod }} is restarting frequently"

        - alert: PodNotReady
          expr: |
            kube_pod_status_ready{namespace="qawave", condition="true"} == 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod is not ready"
            description: "Pod {{ $labels.pod }} has been not ready for 5 minutes"

        - alert: DeploymentReplicasMismatch
          expr: |
            kube_deployment_spec_replicas{namespace="qawave"}
            !=
            kube_deployment_status_replicas_available{namespace="qawave"}
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Deployment replicas mismatch"
            description: "Deployment {{ $labels.deployment }} has {{ $value }} available replicas"

        - alert: PVCAlmostFull
          expr: |
            (
              kubelet_volume_stats_used_bytes{namespace="qawave"}
              /
              kubelet_volume_stats_capacity_bytes{namespace="qawave"}
            ) > 0.85
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PVC almost full"
            description: "PVC {{ $labels.persistentvolumeclaim }} is {{ $value | humanizePercentage }} full"

        - alert: HighCPUThrottling
          expr: |
            (
              sum(rate(container_cpu_cfs_throttled_seconds_total{namespace="qawave"}[5m])) by (pod)
              /
              sum(rate(container_cpu_cfs_periods_total{namespace="qawave"}[5m])) by (pod)
            ) > 0.25
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High CPU throttling"
            description: "Pod {{ $labels.pod }} is being throttled {{ $value | humanizePercentage }}"
