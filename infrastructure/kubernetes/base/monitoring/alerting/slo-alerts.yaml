# PrometheusRule for SLO/SLI Alerts
# Service Level Objectives monitoring

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: qawave-slo-alerts
  namespace: monitoring
  labels:
    app: kube-prometheus-stack
    release: kube-prometheus-stack
    app.kubernetes.io/part-of: qawave
spec:
  groups:
    # SLO Recording Rules
    - name: qawave.slo.recording
      interval: 30s
      rules:
        # API Availability (target: 99.9%)
        - record: qawave:api:availability:ratio
          expr: |
            1 - (
              sum(rate(http_server_requests_seconds_count{job="qawave-backend", status=~"5.."}[5m]))
              /
              sum(rate(http_server_requests_seconds_count{job="qawave-backend"}[5m]))
            )

        # API Latency P50 (target: < 200ms)
        - record: qawave:api:latency:p50
          expr: |
            histogram_quantile(0.50,
              sum(rate(http_server_requests_seconds_bucket{job="qawave-backend"}[5m])) by (le)
            )

        # API Latency P95 (target: < 1s)
        - record: qawave:api:latency:p95
          expr: |
            histogram_quantile(0.95,
              sum(rate(http_server_requests_seconds_bucket{job="qawave-backend"}[5m])) by (le)
            )

        # API Latency P99 (target: < 2s)
        - record: qawave:api:latency:p99
          expr: |
            histogram_quantile(0.99,
              sum(rate(http_server_requests_seconds_bucket{job="qawave-backend"}[5m])) by (le)
            )

        # Error budget remaining (monthly)
        - record: qawave:api:error_budget:remaining
          expr: |
            1 - (
              (1 - qawave:api:availability:ratio)
              /
              (1 - 0.999)  # 99.9% SLO
            )

    # SLO Alerts
    - name: qawave.slo.alerts
      interval: 1m
      rules:
        # Availability SLO Burn Rate (fast burn)
        - alert: SLOAvailabilityBurnRateFast
          expr: |
            (
              sum(rate(http_server_requests_seconds_count{job="qawave-backend", status=~"5.."}[5m]))
              /
              sum(rate(http_server_requests_seconds_count{job="qawave-backend"}[5m]))
            ) > (14.4 * (1 - 0.999))
          for: 2m
          labels:
            severity: critical
            slo: availability
          annotations:
            summary: "SLO: Availability burn rate is very high"
            description: "Burning through error budget 14.4x faster than allowed. Will exhaust monthly budget in 2 hours."

        # Availability SLO Burn Rate (slow burn)
        - alert: SLOAvailabilityBurnRateSlow
          expr: |
            (
              sum(rate(http_server_requests_seconds_count{job="qawave-backend", status=~"5.."}[1h]))
              /
              sum(rate(http_server_requests_seconds_count{job="qawave-backend"}[1h]))
            ) > (3 * (1 - 0.999))
          for: 15m
          labels:
            severity: warning
            slo: availability
          annotations:
            summary: "SLO: Availability burn rate is elevated"
            description: "Burning through error budget 3x faster than allowed. Will exhaust monthly budget in 10 days."

        # Latency SLO (P95 > 1s)
        - alert: SLOLatencyP95High
          expr: qawave:api:latency:p95 > 1
          for: 5m
          labels:
            severity: warning
            slo: latency
          annotations:
            summary: "SLO: P95 latency exceeds target"
            description: "P95 latency is {{ $value | humanizeDuration }} (target: 1s)"

        # Latency SLO (P99 > 2s)
        - alert: SLOLatencyP99High
          expr: qawave:api:latency:p99 > 2
          for: 5m
          labels:
            severity: warning
            slo: latency
          annotations:
            summary: "SLO: P99 latency exceeds target"
            description: "P99 latency is {{ $value | humanizeDuration }} (target: 2s)"

        # Error budget exhausted
        - alert: SLOErrorBudgetExhausted
          expr: qawave:api:error_budget:remaining < 0
          for: 5m
          labels:
            severity: critical
            slo: availability
          annotations:
            summary: "SLO: Error budget exhausted"
            description: "Monthly error budget has been exhausted. Current remaining: {{ $value | humanizePercentage }}"

        # Error budget low
        - alert: SLOErrorBudgetLow
          expr: qawave:api:error_budget:remaining < 0.25
          for: 30m
          labels:
            severity: warning
            slo: availability
          annotations:
            summary: "SLO: Error budget is low"
            description: "Only {{ $value | humanizePercentage }} of error budget remaining for this month"
